{"version":3,"file":"async-ssr-manager.js","sourceRoot":"","sources":["../../../src/internal/async-ssr-manager.ts"],"names":[],"mappings":";;;AAAA,6CAA8C;AAG9C,2DAAoD;AAEpD,KAAK,UAAU,gBAAgB,CAAC,OAAe;IAC7C,MAAM,IAAA,mCAAe,EAAC,OAAO,CAAC,CAAC;IAE/B,MAAM,KAAK,CAAC,+BAA+B,OAAO,MAAM,CAAC,CAAC;AAC5D,CAAC;AAED,MAAa,eAAe;IAK1B,YACmB,OAA+B,EAC/B,OAAgB;QADhB,YAAO,GAAP,OAAO,CAAwB;QAC/B,YAAO,GAAP,OAAO,CAAS;QANlB,2BAAsB,GAAG,IAAI,+BAAiB,EAE5D,CAAC;IAKD,CAAC;IAEG,KAAK,CAAC,oBAAoB,CAC/B,MAAsC;QAEtC,MAAM,eAAe,GAAG,IAAI,GAAG,EAAoB,CAAC;QAEpD,OAAO,IAAI,CAAC,sBAAsB,CAAC,GAAG,CAAC,eAAe,EAAE,KAAK,IAAI,EAAE;YACjE,MAAM,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,eAAe,CAAC,CAAC;YAElE,IAAI,OAAO,IAAI,CAAC,OAAO,KAAK,QAAQ,EAAE;gBACpC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,IAAI,CACtB,4JAA4J,CAC7J,CAAC;gBAEF,OAAO,aAAa,CAAC;aACtB;YAED,OAAO,OAAO,CAAC,IAAI,CAAC,CAAC,aAAa,EAAE,gBAAgB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;QACvE,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,gBAAgB,CACrB,iBAAmC,OAAO,CAAC,OAAO,EAAE;QAEpD,MAAM,eAAe,GAAG,IAAI,CAAC,sBAAsB,CAAC,QAAQ,EAAE,CAAC;QAE/D,IAAI,CAAC,eAAe,EAAE;YACpB,MAAM,IAAI,KAAK,CACb,uFAAuF,CACxF,CAAC;SACH;QAED,eAAe,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;IACtC,CAAC;IAEO,KAAK,CAAC,aAAa,CACzB,MAAsC,EACtC,eAAsC;QAEtC,IAAI,IAAI,GAAG,MAAM,MAAM,EAAE,CAAC;QAE1B,OAAO,eAAe,CAAC,IAAI,GAAG,CAAC,EAAE;YAC/B,OAAO,eAAe,CAAC,IAAI,GAAG,CAAC,EAAE;gBAC/B,sEAAsE;gBACtE,sEAAsE;gBACtE,+CAA+C;gBAE/C,MAAM,uBAAuB,GAAG,KAAK,CAAC,IAAI,CAAC,eAAe,CAAC,MAAM,EAAE,CAAC,CAAC;gBAErE,eAAe,CAAC,KAAK,EAAE,CAAC;gBAExB,MAAM,OAAO,CAAC,GAAG,CAAC,uBAAuB,CAAC,CAAC;aAC5C;YAED,IAAI,GAAG,MAAM,MAAM,EAAE,CAAC;SACvB;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CACF;AApED,0CAoEC","sourcesContent":["import {AsyncLocalStorage} from 'async_hooks';\nimport {AsyncSsrManagerV1} from '..';\nimport {AsyncSsrManagerContext} from './async-ssr-manager-context';\nimport {setTimeoutAsync} from './set-timeout-async';\n\nasync function renderingTimeout(timeout: number): Promise<never> {\n  await setTimeoutAsync(timeout);\n\n  throw Error(`Got rendering timeout after ${timeout} ms.`);\n}\n\nexport class AsyncSsrManager implements AsyncSsrManagerV1 {\n  private readonly asyncOperationsStorage = new AsyncLocalStorage<\n    Set<Promise<unknown>>\n  >();\n\n  public constructor(\n    private readonly context: AsyncSsrManagerContext,\n    private readonly timeout?: number,\n  ) {}\n\n  public async renderUntilCompleted(\n    render: () => Promise<string> | string,\n  ): Promise<string> {\n    const asyncOperations = new Set<Promise<unknown>>();\n\n    return this.asyncOperationsStorage.run(asyncOperations, async () => {\n      const renderPromise = this.renderingLoop(render, asyncOperations);\n\n      if (typeof this.timeout !== 'number') {\n        this.context.logger.warn(\n          'No timeout is configured for the Async SSR Manager. This could lead to unexpectedly long render times or, in the worst case, never resolving render calls!',\n        );\n\n        return renderPromise;\n      }\n\n      return Promise.race([renderPromise, renderingTimeout(this.timeout)]);\n    });\n  }\n\n  public scheduleRerender(\n    asyncOperation: Promise<unknown> = Promise.resolve(),\n  ): void {\n    const asyncOperations = this.asyncOperationsStorage.getStore();\n\n    if (!asyncOperations) {\n      throw new Error(\n        'Async SSR Manager: Can not call `scheduleRerender` outside of `renderUntilCompleted`.',\n      );\n    }\n\n    asyncOperations.add(asyncOperation);\n  }\n\n  private async renderingLoop(\n    render: () => Promise<string> | string,\n    asyncOperations: Set<Promise<unknown>>,\n  ): Promise<string> {\n    let html = await render();\n\n    while (asyncOperations.size > 0) {\n      while (asyncOperations.size > 0) {\n        // Storing a snapshot of the asynchronous operations and clearing them\n        // afterwards, allows that consecutive promises can be added while the\n        // current asynchronous operations are running.\n\n        const asyncOperationsSnapshot = Array.from(asyncOperations.values());\n\n        asyncOperations.clear();\n\n        await Promise.all(asyncOperationsSnapshot);\n      }\n\n      html = await render();\n    }\n\n    return html;\n  }\n}\n"]}