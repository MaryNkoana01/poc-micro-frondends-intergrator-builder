{"version":3,"file":"internal-feature-app-container.js","sourceRoot":"","sources":["../../../src/internal/internal-feature-app-container.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  FeatureAppDefinition,\n  FeatureAppEnvironment,\n  FeatureServices,\n  Logger,\n} from '@feature-hub/core';\nimport * as React from 'react';\nimport {\n  CustomFeatureAppRenderingParams,\n  FeatureApp,\n} from '../feature-app-container';\nimport {FeatureHubContextConsumerValue} from '../feature-hub-context';\nimport {FeatureAppContext} from './feature-app-context';\nimport {isDomFeatureApp, isFeatureApp, isReactFeatureApp} from './type-guards';\n\nexport const handleError = (\n  logger: Logger,\n  error: unknown,\n  onError?: (e: unknown) => void,\n) => {\n  if (onError) {\n    onError(error);\n  } else {\n    logger.error(error);\n  }\n};\n\nexport interface FeatureAppDescriptor {\n  /**\n   * The Feature App ID is used to identify the Feature App instance. Multiple\n   * Feature App Loaders with the same `featureAppId` will render the same\n   * Feature app instance. The ID is also used as a consumer ID for dependent\n   * Feature Services. To render multiple instances of the same kind of Feature\n   * App, different IDs must be used.\n   */\n  readonly featureAppId: string;\n\n  /**\n   * The Feature App's name. In contrast to the `featureAppId`, the name must\n   * not be unique. It can be used by required Feature Services for display\n   * purposes, logging, looking up Feature App configuration meta data, etc.\n   */\n  readonly featureAppName?: string;\n}\n\nexport interface BaseFeatureAppContainerProps<\n  TFeatureApp,\n  TFeatureServices extends FeatureServices = FeatureServices,\n  TConfig = unknown,\n> extends FeatureAppDescriptor {\n  /**\n   * The absolute or relative base URL of the Feature App's assets and/or BFF.\n   */\n  readonly baseUrl?: string;\n\n  /**\n   * The consumer definition of the Feature App.\n   */\n  readonly featureAppDefinition?: FeatureAppDefinition<\n    TFeatureApp,\n    TFeatureServices,\n    TConfig\n  >;\n\n  /**\n   * A config object that is passed to the Feature App's `create` method.\n   */\n  readonly config?: TConfig;\n\n  /**\n   * A callback that is called before the Feature App is created.\n   */\n  readonly beforeCreate?: (\n    env: FeatureAppEnvironment<TFeatureServices, TConfig>,\n  ) => void;\n\n  /**\n   * A callback that is passed to the Feature App's `create` method. A\n   * short-lived Feature App can call this function when it has completed its\n   * task. The Integrator (or parent Feature App) can then decide to e.g.\n   * unmount the Feature App.\n   *\n   * Optionally, the Feature App can pass a result into the done callback. The\n   * type/structure of the result must be agreed between the Integrator (or\n   * parent Feature App) and the Feature App.\n   */\n  readonly done?: (result?: unknown) => void;\n\n  readonly onError?: (error: unknown) => void;\n\n  /**\n   * A children function can be provided to customize rendering of the\n   * Feature App and provide Error or Loading UIs.\n   */\n  readonly children?: (\n    params: CustomFeatureAppRenderingParams,\n  ) => React.ReactNode;\n}\n\nexport type InternalFeatureAppContainerProps<\n  TFeatureApp,\n  TFeatureServices extends FeatureServices,\n  TConfig,\n> = BaseFeatureAppContainerProps<TFeatureApp, TFeatureServices, TConfig> &\n  Pick<FeatureHubContextConsumerValue, 'featureAppManager' | 'logger'> & {\n    readonly parentFeatureApp?: FeatureAppDescriptor;\n  };\n\ninterface InternalFeatureAppContainerState<TFeatureApp extends FeatureApp> {\n  readonly error?: unknown;\n  readonly featureApp?: TFeatureApp;\n  readonly release?: () => void;\n  readonly failedToHandleAsyncError?: boolean;\n  /**\n   * If no loading promise was given, \"loading\" should always be false.\n   */\n  readonly loading: boolean;\n}\n\nexport class InternalFeatureAppContainer<\n  TFeatureApp extends FeatureApp,\n  TFeatureServices extends FeatureServices = FeatureServices,\n  TConfig = unknown,\n> extends React.PureComponent<\n  InternalFeatureAppContainerProps<TFeatureApp, TFeatureServices, TConfig>,\n  InternalFeatureAppContainerState<TFeatureApp>\n> {\n  public static getDerivedStateFromProps(\n    props: InternalFeatureAppContainerProps<unknown, FeatureServices, unknown>,\n    state: InternalFeatureAppContainerState<FeatureApp>,\n  ): Partial<InternalFeatureAppContainerState<FeatureApp>> | null {\n    const {\n      baseUrl,\n      beforeCreate,\n      config,\n      featureAppId,\n      featureAppName,\n      featureAppManager,\n      featureAppDefinition,\n      done,\n      logger,\n      onError,\n      parentFeatureApp,\n    } = props;\n\n    if (featureAppDefinition && !state.featureApp && !state.error) {\n      try {\n        const featureAppScope = featureAppManager.createFeatureAppScope(\n          featureAppId,\n          featureAppDefinition,\n          {\n            featureAppName,\n            baseUrl,\n            config,\n            beforeCreate,\n            done,\n            parentFeatureApp,\n          },\n        );\n\n        const {featureApp, release} = featureAppScope;\n\n        if (!isFeatureApp(featureApp)) {\n          throw new Error(\n            'Invalid Feature App found. The Feature App must be an object with either 1) a `render` method that returns a React element, or 2) an `attachTo` method that accepts a container DOM element.',\n          );\n        }\n\n        return {\n          featureApp,\n          release,\n          loading: Boolean(featureApp.loadingPromise),\n        };\n      } catch (error) {\n        try {\n          handleError(logger, error, onError);\n        } catch (handlerError) {\n          return {\n            error: handlerError,\n            loading: false,\n            failedToHandleAsyncError: true,\n          };\n        }\n\n        return {error, loading: false};\n      }\n    }\n\n    return null;\n  }\n\n  public state: InternalFeatureAppContainerState<TFeatureApp> = {loading: true};\n\n  private readonly containerRef = React.createRef<HTMLDivElement>();\n  private mounted = false;\n  private loadingPromiseHandled = false;\n  private domFeatureAppAttached = false;\n\n  public componentDidCatch(error: unknown): void {\n    this.handleError(error);\n    this.setState({error, loading: false});\n  }\n\n  public componentDidMount(): void {\n    this.mounted = true;\n    this.attachDomFeatureApp();\n    this.handleLoading();\n  }\n\n  public componentDidUpdate(): void {\n    this.attachDomFeatureApp();\n    this.handleLoading();\n  }\n\n  public componentWillUnmount(): void {\n    this.mounted = false;\n\n    if (this.state && this.state.release) {\n      try {\n        this.state.release();\n      } catch (error) {\n        this.handleError(error);\n      }\n    }\n  }\n\n  public render(): React.ReactNode {\n    if ('error' in this.state && this.state.error) {\n      if (this.state.failedToHandleAsyncError) {\n        throw this.state.error;\n      }\n\n      return this.renderError(this.state.error);\n    }\n\n    const {children, featureAppId, featureAppName} = this.props;\n\n    if (!this.state.featureApp) {\n      return children ? children({loading: true}) : null;\n    }\n\n    const {featureApp, loading} = this.state;\n\n    let featureAppNode: React.ReactNode;\n\n    if (isReactFeatureApp(featureApp)) {\n      try {\n        featureAppNode = featureApp.render();\n      } catch (error) {\n        this.handleError(error);\n\n        return this.renderError(error);\n      }\n    } else {\n      featureAppNode = <div ref={this.containerRef} />;\n    }\n\n    return (\n      <FeatureAppContext.Provider value={{featureAppId, featureAppName}}>\n        {children ? children({featureAppNode, loading}) : featureAppNode}\n      </FeatureAppContext.Provider>\n    );\n  }\n\n  private handleLoading(): void {\n    const {featureApp} = this.state;\n\n    if (\n      featureApp &&\n      featureApp.loadingPromise &&\n      !this.loadingPromiseHandled\n    ) {\n      this.loadingPromiseHandled = true;\n\n      featureApp.loadingPromise\n        .then(() => {\n          if (this.mounted) {\n            this.setState({loading: false});\n          }\n        })\n        .catch((loadingError) => {\n          try {\n            this.handleError(loadingError);\n\n            if (this.mounted) {\n              this.setState({\n                error: loadingError,\n                failedToHandleAsyncError: false,\n                loading: false,\n              });\n            }\n          } catch (handlerError) {\n            if (this.mounted) {\n              this.setState({\n                error: handlerError,\n                failedToHandleAsyncError: true,\n                loading: false,\n              });\n            }\n          }\n        });\n    }\n  }\n\n  private renderError(error: unknown): React.ReactNode {\n    const {children} = this.props;\n\n    return children ? children({error, loading: false}) : null;\n  }\n\n  private handleError(error: unknown): void {\n    const {logger, onError} = this.props;\n\n    handleError(logger, error, onError);\n  }\n\n  private attachDomFeatureApp(): void {\n    if (\n      this.state.featureApp &&\n      !this.domFeatureAppAttached &&\n      this.containerRef.current &&\n      !('error' in this.state) &&\n      isDomFeatureApp(this.state.featureApp)\n    ) {\n      try {\n        this.state.featureApp.attachTo(this.containerRef.current);\n        this.domFeatureAppAttached = true;\n      } catch (error) {\n        this.componentDidCatch(error);\n      }\n    }\n  }\n}\n"]}