{"version":3,"file":"feature-app-loader.js","sourceRoot":"","sources":["../../src/feature-app-loader.tsx"],"names":[],"mappings":"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","sourcesContent":["import {\n  FeatureAppDefinition,\n  FeatureAppEnvironment,\n  FeatureServices,\n} from '@feature-hub/core';\nimport * as React from 'react';\nimport {\n  CustomFeatureAppRenderingParams,\n  FeatureApp,\n} from './feature-app-container';\nimport {\n  Css,\n  FeatureHubContextConsumer,\n  FeatureHubContextConsumerValue,\n} from './feature-hub-context';\nimport {\n  FeatureAppDescriptor,\n  InternalFeatureAppContainer,\n} from './internal/internal-feature-app-container';\nimport {prependBaseUrl} from './internal/prepend-base-url';\n\nexport interface FeatureAppLoaderProps<TConfig = unknown>\n  extends FeatureAppDescriptor {\n  /**\n   * The absolute or relative base URL of the Feature App's assets and/or BFF.\n   */\n  readonly baseUrl?: string;\n\n  /**\n   * The URL of the Feature App's client module bundle. If [[baseUrl]] is\n   * specified, it will be prepended, unless `src` is an absolute URL.\n   */\n  readonly src: string;\n\n  /**\n   * The module type of the Feature App's client module bundle. It is passed to\n   * the module loader that was provided as part of\n   * [[FeatureAppManagerOptions.moduleLoader]].\n   */\n  readonly moduleType?: string;\n\n  /**\n   * The URL of the Feature App's server module bundle. If [[baseUrl]] is\n   * specified, it will be prepended, unless `serverSrc` is an absolute URL.\n   * Either [[baseUrl]] or `serverSrc` must be an absolute URL.\n   */\n  readonly serverSrc?: string;\n\n  /**\n   * The module type of the Feature App's server module bundle. It is passed to\n   * the module loader that was provided as part of\n   * [[FeatureAppManagerOptions.moduleLoader]].\n   */\n  readonly serverModuleType?: string;\n\n  /**\n   * A list of stylesheets to be added to the document. If [[baseUrl]] is\n   * specified, it will be prepended, unless [[Css.href]] is an absolute URL.\n   */\n  readonly css?: Css[];\n\n  /**\n   * A config object that is passed to the Feature App's `create` method.\n   */\n  readonly config?: TConfig;\n\n  /**\n   * A callback that is called before the Feature App is created.\n   */\n  readonly beforeCreate?: (\n    env: FeatureAppEnvironment<FeatureServices, TConfig>,\n  ) => void;\n\n  /**\n   * A callback that is passed to the Feature App's `create` method. A\n   * short-lived Feature App can call this function when it has completed its\n   * task. The Integrator (or parent Feature App) can then decide to e.g.\n   * unmount the Feature App.\n   *\n   * Optionally, the Feature App can pass a result into the done callback. The\n   * type/structure of the result must be agreed between the Integrator (or\n   * parent Feature App) and the Feature App.\n   */\n  readonly done?: (result?: unknown) => void;\n\n  readonly onError?: (error: unknown) => void;\n\n  /**\n   * A children function can be provided to customize rendering of the\n   * Feature App and provide Error or Loading UIs.\n   */\n  readonly children?: (\n    params: CustomFeatureAppRenderingParams,\n  ) => React.ReactNode;\n}\n\ntype InternalFeatureAppLoaderProps<TConfig> = FeatureAppLoaderProps<TConfig> &\n  FeatureHubContextConsumerValue;\n\ninterface InternalFeatureAppLoaderState {\n  readonly featureAppDefinition?: FeatureAppDefinition<unknown>;\n  readonly error?: unknown;\n  readonly failedToHandleAsyncError?: boolean;\n}\n\nconst inBrowser =\n  typeof window === 'object' &&\n  typeof document === 'object' &&\n  document.nodeType === 9;\n\nclass InternalFeatureAppLoader<TConfig = unknown> extends React.PureComponent<\n  InternalFeatureAppLoaderProps<TConfig>,\n  InternalFeatureAppLoaderState\n> {\n  public readonly state: InternalFeatureAppLoaderState = {};\n\n  private errorHandled = false;\n  private mounted = false;\n\n  public constructor(props: InternalFeatureAppLoaderProps<TConfig>) {\n    super(props);\n\n    const {\n      baseUrl,\n      featureAppManager,\n      src: clientSrc,\n      serverSrc,\n      asyncSsrManager,\n      addUrlForHydration,\n      addStylesheetsForSsr,\n      moduleType: clientModuleType,\n      serverModuleType,\n    } = props;\n\n    const src = inBrowser ? clientSrc : serverSrc;\n    const moduleType = inBrowser ? clientModuleType : serverModuleType;\n\n    if (!src) {\n      if (inBrowser) {\n        throw new Error('No src provided.');\n      }\n\n      return;\n    }\n\n    if (!inBrowser && addUrlForHydration) {\n      addUrlForHydration(prependBaseUrl(baseUrl, clientSrc), clientModuleType);\n    }\n\n    if (!inBrowser && addStylesheetsForSsr) {\n      const css = this.prependCssHrefs();\n\n      if (css) {\n        addStylesheetsForSsr(css);\n      }\n    }\n\n    const url = prependBaseUrl(baseUrl, src);\n\n    const {\n      error,\n      promise: loadingPromise,\n      value: featureAppDefinition,\n    } = featureAppManager.getAsyncFeatureAppDefinition(url, moduleType);\n\n    if (error) {\n      this.handleError(error);\n\n      this.state = {error};\n    } else if (featureAppDefinition) {\n      this.state = {featureAppDefinition};\n    } else if (!inBrowser && asyncSsrManager) {\n      asyncSsrManager.scheduleRerender(loadingPromise);\n    }\n  }\n\n  public async componentDidMount(): Promise<void> {\n    this.mounted = true;\n\n    this.appendCss();\n\n    if (this.state.featureAppDefinition) {\n      return;\n    }\n\n    const {baseUrl, featureAppManager, src, moduleType} = this.props;\n\n    try {\n      const featureAppDefinition =\n        await featureAppManager.getAsyncFeatureAppDefinition(\n          prependBaseUrl(baseUrl, src),\n          moduleType,\n        ).promise;\n\n      if (this.mounted) {\n        this.setState({featureAppDefinition});\n      }\n    } catch (error) {\n      try {\n        this.handleError(error);\n\n        if (this.mounted) {\n          this.setState({error});\n        }\n      } catch (handlerError) {\n        if (this.mounted) {\n          this.setState({error: handlerError, failedToHandleAsyncError: true});\n        }\n      }\n    }\n  }\n\n  public componentWillUnmount(): void {\n    this.mounted = false;\n  }\n\n  public render(): React.ReactNode {\n    const {\n      baseUrl,\n      beforeCreate,\n      children,\n      config,\n      featureAppId,\n      featureAppName,\n      onError,\n      done,\n      featureAppManager,\n      logger,\n    } = this.props;\n\n    const {error, failedToHandleAsyncError, featureAppDefinition} = this.state;\n\n    if (error) {\n      if (failedToHandleAsyncError) {\n        throw error;\n      }\n\n      if (children) {\n        return children({error, loading: false});\n      }\n\n      return null;\n    }\n\n    if (!featureAppDefinition && !children) {\n      return null;\n    }\n\n    return (\n      <InternalFeatureAppContainer\n        children={children}\n        baseUrl={baseUrl}\n        beforeCreate={beforeCreate}\n        config={config}\n        featureAppId={featureAppId}\n        featureAppName={featureAppName}\n        featureAppDefinition={\n          featureAppDefinition as FeatureAppDefinition<FeatureApp>\n        }\n        onError={onError}\n        done={done}\n        featureAppManager={featureAppManager}\n        logger={logger}\n      />\n    );\n  }\n\n  private appendCss(): void {\n    const css = this.prependCssHrefs();\n\n    if (!css) {\n      return;\n    }\n\n    for (const {href, media = 'all'} of css) {\n      if (!document.querySelector(`link[href=\"${href}\"]`)) {\n        document.head.appendChild(\n          Object.assign(document.createElement('link'), {\n            rel: 'stylesheet',\n            href,\n            media,\n          }),\n        );\n      }\n    }\n  }\n\n  private prependCssHrefs(): Css[] | undefined {\n    const {baseUrl, css} = this.props;\n\n    if (!baseUrl || !css) {\n      return css;\n    }\n\n    return css.map(({href, media}) => ({\n      href: prependBaseUrl(baseUrl, href),\n      media,\n    }));\n  }\n\n  private handleError(error: unknown): void {\n    if (this.errorHandled) {\n      return;\n    }\n\n    this.errorHandled = true;\n\n    if (this.props.onError) {\n      this.props.onError(error);\n    } else {\n      this.logError(error);\n    }\n  }\n\n  private logError(error: unknown): void {\n    const {\n      baseUrl,\n      featureAppId,\n      logger,\n      src: clientSrc,\n      serverSrc,\n    } = this.props;\n\n    const src = inBrowser ? clientSrc : serverSrc;\n\n    logger.error(\n      `The Feature App for the src ${JSON.stringify(\n        src && prependBaseUrl(baseUrl, src),\n      )} and the ID ${JSON.stringify(featureAppId)} could not be rendered.`,\n      error,\n    );\n  }\n}\n\n/**\n * The `FeatureAppLoader` component allows the integrator to load Feature Apps\n * from a remote location. It can also be used by a Feature App to render\n * another Feature App as a child.\n *\n * When a Feature App throws an error while rendering or, in the case of a\n * [[ReactFeatureApp]], throws an error in a lifecycle method, the\n * `FeatureAppLoader` renders `null`. On the server, however, rendering\n * errors are not caught and must therefore be handled by the integrator.\n */\nexport function FeatureAppLoader<TConfig>(\n  props: FeatureAppLoaderProps<TConfig>,\n): JSX.Element {\n  return (\n    <FeatureHubContextConsumer>\n      {(featureHubContextValue) => (\n        <InternalFeatureAppLoader<TConfig>\n          {...featureHubContextValue}\n          {...props}\n        />\n      )}\n    </FeatureHubContextConsumer>\n  );\n}\n"]}