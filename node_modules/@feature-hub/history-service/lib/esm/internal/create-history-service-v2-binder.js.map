{"version":3,"file":"create-history-service-v2-binder.js","sourceRoot":"","sources":["../../../src/internal/create-history-service-v2-binder.ts"],"names":[],"mappings":"AAEA,OAAO,EAAC,sBAAsB,EAAC,MAAM,4BAA4B,CAAC;AAIlE,OAAO,EAAC,sBAAsB,EAAC,MAAM,6BAA6B,CAAC;AAGnE,OAAO,EAAC,qBAAqB,EAAC,MAAM,2BAA2B,CAAC;AAOhE,SAAS,sBAAsB,CAC7B,OAA8B,EAC9B,UAAkB,EAClB,eAAgC,EAChC,kBAAsC;IAEtC,OAAO;QACL,UAAU;QACV,OAAO,EAAE,sBAAsB,CAAC,OAAO,EAAE,eAAe,CAAC;QACzD,WAAW,EAAE,kBAAkB,CAAC,aAAa;QAE7C,yCAAyC,EAAE,CAAC,GAAG,iBAAiB,EAAE,EAAE,CAClE,kBAAkB,CAAC,yCAAyC,CAC1D,GAAG,iBAAiB,CAAC,GAAG,CACtB,CAAC,EACC,UAAU,EAAE,eAAe,EAC3B,QAAQ,EAAE,EAAC,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAC,GAC1C,EAAE,EAAE,CAAC,CAAC;YACL,UAAU,EAAE,eAAe;YAC3B,QAAQ,EAAE,EAAC,QAAQ,EAAE,MAAM,EAAE,IAAI,EAAC;YAClC,KAAK;SACN,CAAC,CACH,CACF;KACJ,CAAC;AACJ,CAAC;AAED,SAAS,oCAAoC,CAC3C,OAA8B,EAC9B,mBAAwC,EACxC,UAAkB;IAElB,MAAM,eAAe,GAAG,IAAI,sBAAsB,CAChD,OAAO,EACP,UAAU,EACV,mBAAmB,CAAC,yBAAyB,CAC9C,CAAC;IAEF,OAAO;QACL,cAAc,EAAE,sBAAsB,CACpC,OAAO,EACP,UAAU,EACV,eAAe,EACf,mBAAmB,CAAC,yBAAyB,CAC9C;QAED,MAAM,EAAE,GAAG,EAAE;YACX,eAAe,CAAC,OAAO,EAAE,CAAC;QAC5B,CAAC;KACF,CAAC;AACJ,CAAC;AAED,SAAS,mCAAmC,CAC1C,OAA8B,EAC9B,mBAAwC,EACxC,UAAkB;IAElB,MAAM,eAAe,GAAG,IAAI,qBAAqB,CAC/C,OAAO,EACP,UAAU,EACV,mBAAmB,CAAC,wBAAwB,CAC7C,CAAC;IAEF,OAAO;QACL,cAAc,EAAE,sBAAsB,CACpC,OAAO,EACP,UAAU,EACV,eAAe,EACf,mBAAmB,CAAC,wBAAwB,CAC7C;KACF,CAAC;AACJ,CAAC;AAED,MAAM,UAAU,4BAA4B,CAC1C,OAA8B,EAC9B,mBAAwC,EACxC,OAA4C;IAE5C,MAAM,EAAC,IAAI,EAAE,aAAa,EAAC,GAAG,OAAO,CAAC;IAEtC,OAAO,CACL,UAAU,EACV,YAAY,EAC6B,EAAE;QAC3C,MAAM,UAAU,GAAG,aAAa,CAAC,EAAC,UAAU,EAAE,YAAY,EAAC,CAAC,CAAC;QAE7D,OAAO,IAAI,KAAK,SAAS;YACvB,CAAC,CAAC,oCAAoC,CAClC,OAAO,EACP,mBAAmB,EACnB,UAAU,CACX;YACH,CAAC,CAAC,mCAAmC,CACjC,OAAO,EACP,mBAAmB,EACnB,UAAU,CACX,CAAC;IACR,CAAC,CAAC;AACJ,CAAC","sourcesContent":["import {FeatureServiceBinder, FeatureServiceBinding} from '@feature-hub/core';\nimport {HistoryServiceV2} from '..';\nimport {BrowserConsumerHistory} from './browser-consumer-history';\nimport {ConsumerHistory} from './consumer-history';\nimport {HistoryMultiplexers} from './create-history-multiplexers';\nimport {GetHistoryKeyOptions} from './create-history-service-v3-binder';\nimport {createHistoryV4Adapter} from './create-history-v4-adapter';\nimport {HistoryMultiplexer} from './history-multiplexer';\nimport {HistoryServiceContext} from './history-service-context';\nimport {StaticConsumerHistory} from './static-consumer-history';\n\nexport interface CreateHistoryServiceV2BinderOptions {\n  readonly mode: 'browser' | 'static';\n  readonly getHistoryKey: (options: GetHistoryKeyOptions) => string;\n}\n\nfunction createHistoryServiceV2(\n  context: HistoryServiceContext,\n  historyKey: string,\n  consumerHistory: ConsumerHistory,\n  historyMultiplexer: HistoryMultiplexer,\n): HistoryServiceV2 {\n  return {\n    historyKey,\n    history: createHistoryV4Adapter(context, consumerHistory),\n    rootHistory: historyMultiplexer.rootHistoryV2,\n\n    createNewRootLocationForMultipleConsumers: (...consumerLocations) =>\n      historyMultiplexer.createNewRootLocationForMultipleConsumers(\n        ...consumerLocations.map(\n          ({\n            historyKey: otherHistoryKey,\n            location: {pathname, search, hash, state},\n          }) => ({\n            historyKey: otherHistoryKey,\n            location: {pathname, search, hash},\n            state,\n          }),\n        ),\n      ),\n  };\n}\n\nfunction createBrowserHistoryServiceV2Binding(\n  context: HistoryServiceContext,\n  historyMultiplexers: HistoryMultiplexers,\n  historyKey: string,\n): FeatureServiceBinding<HistoryServiceV2> {\n  const consumerHistory = new BrowserConsumerHistory(\n    context,\n    historyKey,\n    historyMultiplexers.browserHistoryMultiplexer,\n  );\n\n  return {\n    featureService: createHistoryServiceV2(\n      context,\n      historyKey,\n      consumerHistory,\n      historyMultiplexers.browserHistoryMultiplexer,\n    ),\n\n    unbind: () => {\n      consumerHistory.destroy();\n    },\n  };\n}\n\nfunction createStaticHistoryServiceV2Binding(\n  context: HistoryServiceContext,\n  historyMultiplexers: HistoryMultiplexers,\n  historyKey: string,\n): FeatureServiceBinding<HistoryServiceV2> {\n  const consumerHistory = new StaticConsumerHistory(\n    context,\n    historyKey,\n    historyMultiplexers.staticHistoryMultiplexer,\n  );\n\n  return {\n    featureService: createHistoryServiceV2(\n      context,\n      historyKey,\n      consumerHistory,\n      historyMultiplexers.staticHistoryMultiplexer,\n    ),\n  };\n}\n\nexport function createHistoryServiceV2Binder(\n  context: HistoryServiceContext,\n  historyMultiplexers: HistoryMultiplexers,\n  options: CreateHistoryServiceV2BinderOptions,\n): FeatureServiceBinder<HistoryServiceV2> {\n  const {mode, getHistoryKey} = options;\n\n  return (\n    consumerId,\n    consumerName,\n  ): FeatureServiceBinding<HistoryServiceV2> => {\n    const historyKey = getHistoryKey({consumerId, consumerName});\n\n    return mode === 'browser'\n      ? createBrowserHistoryServiceV2Binding(\n          context,\n          historyMultiplexers,\n          historyKey,\n        )\n      : createStaticHistoryServiceV2Binding(\n          context,\n          historyMultiplexers,\n          historyKey,\n        );\n  };\n}\n"]}