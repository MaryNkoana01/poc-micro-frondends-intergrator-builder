name: AzureStaticWebAppDeployment

on:
  push:
    branches:
      - main

jobs:
  deploy-to-azure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1

      - name: Set up Node.js
        uses: actions/setup-node@v4.0.1
        with:
          node-version: 20

      - name: Clear npm cache
        run: npm cache verify

      - name: Install dependencies
        run: npm install

      - name: Build the app
        run: npm run build

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Upload files to Azure Storage
        uses: Azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az storage blob upload-batch --account-name microfrontendstorage1 --destination microfrontendcontainer1 --source dist --output none

      - name: Configure CDN Endpoint
        uses: Azure/CLI@v1
        with:
          azcliversion: latest
          inlineScript: |
            az cdn endpoint create -n microfrontendcdnendpoint1 -g microfrontend1 --profile-name microfrontendcdn1 --origin microfrontendstorage1.blob.core.windows.net --origin-host-header microfrontendstorage1.blob.core.windows.net

      # - name: Check CDN Endpoint Provisioning Status
      #   id: check_cdn_status
      #   run: |
      #     while true; do
      #       status=$(az cdn endpoint show -n microfrontendcdnendpoint1 -g microfrontend1 --query 'properties.provisioningState' -o tsv)
      #       if [ "$status" == "Succeeded" ]; then
      #         break
      #       fi
      #       sleep 10
      #     done
      #     echo "CDN Endpoint provisioned successfully."

      - name: Get CDN Endpoint URL
        id: get_cdn_url
        run: |
          while true; do
            status=$(az cdn endpoint show -n microfront -g microfrontend1 --profile-name microfrontendcdn1 --query 'provisioningState' -o tsv)
            if [ "$status" == "Succeeded" ]; then
              break
            fi
            sleep 10
          done
          echo "CDN Endpoint provisioned successfully."


      - name: Update index.html URLs
        run: |
          cd dist && sed -i "s|http://127.0.0.1:5500/dist/|${{ steps.get_cdn_url.outputs.cdn_url }}/|g" index.html

      - name: Test Deployment
        run: |
          echo "Wait for the CDN endpoint to finish provisioning..."
          echo "Once provisioned, you can access your microfrontend using the CDN endpoint URL: ${{ steps.get_cdn_url.outputs.cdn_url }}"
